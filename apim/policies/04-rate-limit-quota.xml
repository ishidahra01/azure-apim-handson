<!--
シナリオC: レート制限とクォータポリシー
サブスクリプションキーベースのアクセス制御とスロットリング

このポリシーは以下を実行します:
1. サブスクリプションキーごとのレート制限（10回/分）
2. サブスクリプションキーごとのクォータ（10,000回/日）
3. バックエンドコード変更なしでアクセス制御を実現

利点: プロダクトごとに異なる制限値を設定可能
      コード変更なしで利用プラン（Basic/Partner等）を差別化
-->
<policies>
    <inbound>
        <base />
        
        <!-- レート制限: 10回/60秒（1分間） -->
        <rate-limit-by-key 
            calls="10" 
            renewal-period="60" 
            counter-key="@(context.Subscription?.Key ?? "anonymous")" 
            increment-condition="@(context.Response.StatusCode >= 200 && context.Response.StatusCode < 300)" />
        
        <!-- クォータ: 10,000回/日 -->
        <quota-by-key 
            calls="10000" 
            renewal-period="86400" 
            counter-key="@(context.Subscription?.Key ?? "anonymous")" 
            increment-condition="@(context.Response.StatusCode >= 200 && context.Response.StatusCode < 300)" />
        
        <!-- 使用状況をレスポンスヘッダーに追加 -->
        <set-variable name="subscription-key" value="@(context.Subscription?.Key ?? "anonymous")" />
    </inbound>
    
    <backend>
        <base />
    </backend>
    
    <outbound>
        <base />
        
        <!-- レート制限情報をヘッダーに追加 -->
        <set-header name="X-RateLimit-Limit" exists-action="override">
            <value>10</value>
        </set-header>
        
        <set-header name="X-RateLimit-Remaining" exists-action="override">
            <value>@{
                // 注意: 実際の残り回数の取得は複雑なため、ここでは簡略化
                return "N/A (see APIM analytics)";
            }</value>
        </set-header>
        
        <set-header name="X-Quota-Limit" exists-action="override">
            <value>10000</value>
        </set-header>
        
        <!-- サブスクリプション情報をヘッダーに追加（デバッグ用） -->
        <set-header name="X-Subscription-Name" exists-action="override">
            <value>@(context.Subscription?.Name ?? "Anonymous")</value>
        </set-header>
    </outbound>
    
    <on-error>
        <base />
        
        <!-- レート制限エラーのカスタマイズ -->
        <choose>
            <when condition="@(context.LastError.Reason == "RateLimitExceeded")">
                <return-response>
                    <set-status code="429" reason="Too Many Requests" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-header name="Retry-After" exists-action="override">
                        <value>60</value>
                    </set-header>
                    <set-body>@{
                        return new Newtonsoft.Json.Linq.JObject
                        {
                            ["error"] = "RateLimitExceeded",
                            ["message"] = "レート制限を超過しました。1分あたり10リクエストまでです。",
                            ["retryAfter"] = 60,
                            ["timestamp"] = DateTime.UtcNow.ToString("o")
                        }.ToString();
                    }</set-body>
                </return-response>
            </when>
            <when condition="@(context.LastError.Reason == "QuotaExceeded")">
                <return-response>
                    <set-status code="429" reason="Quota Exceeded" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-body>@{
                        return new Newtonsoft.Json.Linq.JObject
                        {
                            ["error"] = "QuotaExceeded",
                            ["message"] = "1日のクォータ（10,000リクエスト）を超過しました。",
                            ["resetAt"] = DateTime.UtcNow.Date.AddDays(1).ToString("o"),
                            ["timestamp"] = DateTime.UtcNow.ToString("o")
                        }.ToString();
                    }</set-body>
                </return-response>
            </when>
        </choose>
    </on-error>
</policies>
